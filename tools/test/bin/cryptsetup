#!/usr/bin/env bash
store=$BATS_TEST_TMPDIR/host-testhost.local/keys/luks-key
tmp_store=$store.tmp
key=$(cat "${3#--key-file=}")

test-key() {
  if ! grep -Fxq "$key" "$store"; then
    echo "No key available with this passphrase."
    exit 1
  fi
}

case $1 in
open)
  test-key "$@"
  ;;
luksAddKey)
  test-key
  cat "${4#--new-keyfile=}" >>"$store"
  echo >>"$store"
  ;;
luksRemoveKey)
  grep -vxF "$key" "$store" >"$tmp_store" && mv "$tmp_store" "$store"
  exit 0
  ;;
*)
  exit 1
  ;;
esac
